name: Deploy Helm to GKE (No DNS)

on:
  workflow_dispatch:
  push:
    paths:
      - 'helm/**'
     
jobs:
  deploy:
    name: Deploy Helm Chart
    runs-on: ubuntu-latest

    env:
      HELM_RELEASE_NAME: microservice-ingress
      HELM_CHART_DIR: ./helm/microservice

    steps:
      # ‚úÖ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ‚úÖ Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # ‚úÖ Set up Google Cloud CLI
      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'
          export_default_credentials: true

      # ‚úÖ Get GKE credentials
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      # ‚úÖ Install kubectl
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      # ‚úÖ Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      # ‚úÖ Install Ingress-NGINX Controller via Helm
      - name: Install Ingress-NGINX Controller
        run: |
          echo "üîß Installing Ingress-NGINX via Helm..."
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --set controller.publishService.enabled=true

          echo "‚è≥ Waiting for ingress-nginx-controller pod to be ready..."
          for i in {1..30}; do
            READY=$(kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller -o jsonpath='{.items[0].status.containerStatuses[0].ready}' 2>/dev/null)
            if [ "$READY" = "true" ]; then
              echo "‚úÖ Ingress-NGINX controller is ready."
              break
            fi
            echo "‚è≥ Attempt $i: Controller not ready yet..."
            sleep 10
          done

          if [ "$READY" != "true" ]; then
            echo "‚ùå Timeout waiting for Ingress-NGINX controller to be ready."
            kubectl describe pods -n ingress-nginx
            kubectl get events -n ingress-nginx --sort-by='.metadata.creationTimestamp'
            exit 1
          fi

      # ‚úÖ Debug Helm chart path
      - name: Debug Helm chart path
        run: |
          echo "üîç Listing Helm chart files:"
          ls -l $HELM_CHART_DIR
          echo "üìÑ Chart.yaml contents:"
          cat $HELM_CHART_DIR/Chart.yaml

      # ‚úÖ Deploy Helm chart
      - name: Deploy via Helm
        run: |
          helm upgrade --install $HELM_RELEASE_NAME $HELM_CHART_DIR \
            --namespace default --create-namespace

      # ‚úÖ Get Ingress IP
      - name: Get Ingress IP
        run: |
          echo "‚è≥ Waiting for Ingress IP to be assigned..."
          for i in {1..20}; do
            IP=$(kubectl get ingress -n default -o jsonpath="{.items[0].status.loadBalancer.ingress[0].ip}" 2>/dev/null)
            if [[ -n "$IP" ]]; then
              echo "‚úÖ App is available at:"
              echo "http://$IP or http://$IP.nip.io"
              exit 0
            fi
            echo "‚è≥ Attempt $i: Ingress IP not assigned yet..."
            sleep 10
          done
          echo "‚ùå Ingress IP not found after timeout."
          exit 1




